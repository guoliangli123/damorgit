!function(t){function s(){this.MODE_CHARACTER=1,this.MODE_TAG=2,this.MODE_WHITESPACE=3,this.ACTION_EQUAL=1,this.ACTION_DELETE=2,this.ACTION_INSERT=3,this.ACTION_NONE=4,this.ACTION_REPLACE=5,this.specialCaseOpeningTags=new Array("<strong[\\>\\s]+","<b[\\>\\s]+","<i[\\>\\s]+","<big[\\>\\s]+","<small[\\>\\s]+","<u[\\>\\s]+","<sub[\\>\\s]+","<sup[\\>\\s]+","<strike[\\>\\s]+","<s[\\>\\s]+"),this.specialCaseClosingTags=new Array("</strong>","</b>","</i>","</big>","</small>","</u>","</sub>","</sup>","</strike>","</s>"),this.content="",this.wordIndices="",this.oldWords="",this.newWords=""}s.prototype={compare:function(t,s){this.content=new Array,this.wordIndices=new Array,this.oldWords=this.ConvertHtmlToListOfWords(t),this.newWords=this.ConvertHtmlToListOfWords(s),this.wordIndices=this.IndexNewWords(this.newWords);for(var n=this.Operations(),i=0;i<n.length;i++){var r=n[i];this.PerformOperation(r)}return this.content.join("")},Operations:function(){var t=0,s=0,n=new Array,i=this.MatchingBlocks();i.push(this.Match(this.oldWords.length,this.newWords.length,0));for(var r=0;r<i.length;r++){var e=i[r],a=t==e.StartInOld,h=s==e.StartInNew,o=this.ACTION_NONE;o=0==a&&0==h?this.ACTION_REPLACE:1==a&&0==h?this.ACTION_INSERT:0==a&&1==h?this.ACTION_DELETE:this.ACTION_NONE,o!=this.ACTION_NONE&&n.push(this.Operation(o,t,e.StartInOld,s,e.StartInNew)),0!=e.length&&n.push(this.Operation(this.ACTION_EQUAL,e.StartInOld,e.EndInOld(),e.StartInNew,e.EndInNew())),t=e.EndInOld(),s=e.EndInNew()}return n},MatchingBlocks:function(){var t=new Array;return this.FindMatchingBlocks(0,this.oldWords.length,0,this.newWords.length,t),t},FindMatchingBlocks:function(t,s,n,i,r){var e=this.FindMatch(t,s,n,i);null!=e&&(t<e.StartInOld&&n<e.StartInNew&&this.FindMatchingBlocks(t,e.StartInOld,n,e.StartInNew,r),r.push(e),e.EndInOld()<s&&e.EndInNew()<i&&this.FindMatchingBlocks(e.EndInOld(),s,e.EndInNew(),i,r))},FindMatch:function(t,s,n,i){for(var r=t,e=n,a=0,h=new Array,o=t;o<s;o++){var c=new Array,d=this.oldWords[o];if(this.wordIndices[d]){for(var l=0;l<this.wordIndices[d].length;l++){var I=this.wordIndices[d][l];if(!(I<n)){if(I>=i)break;newMatchLength=(h[I-1]?h[I-1]:0)+1,c[I]=newMatchLength,newMatchLength>a&&(r=o-newMatchLength+1,e=I-newMatchLength+1,a=newMatchLength)}}h=c}else h=c}return 0!=a?this.Match(r,e,a):null},IndexNewWords:function(t){for(var s=new Array,n=0;n<t.length;n++){var i=t[n];s[i]?s[i].push(n):s[i]=[n]}return s},ConvertHtmlToListOfWords:function(t){for(var s=this.MODE_CHARACTER,n="",i=new Array,r=0;r<t.length;r++){var e=t[r];switch(s){case this.MODE_CHARACTER:this.IsStartOfTag(e)?(n&&i.push(n),n="<",s=this.MODE_TAG):this.IsWhiteSpace(e)?(n&&i.push(n),n=e,s=this.MODE_WHITESPACE):this.isNaW(n+e)?(n&&i.push(n),n=e):n+=e;break;case this.MODE_TAG:this.IsEndOfTag(e)?(n+=">",i.push(n),n="",s=this.IsWhiteSpace(e)?this.MODE_WHITESPACE:this.MODE_CHARACTER):n+=e;break;case this.MODE_WHITESPACE:this.IsStartOfTag(e)?(n&&i.push(n),n="<",s=this.MODE_TAG):this.IsWhiteSpace(e)?n+=e:(n&&i.push(n),n=e,s=this.MODE_CHARACTER)}}return n&&i.push(n),i},PerformOperation:function(t){switch(t.Action){case this.ACTION_EQUAL:this.ProcessEqualOperation(t);break;case this.ACTION_DELETE:this.ProcessDeleteOperation(t,"diffdel");break;case this.ACTION_INSERT:this.ProcessInsertOperation(t,"diffins");break;case this.ACTION_NONE:break;case this.ACTION_REPLACE:this.ProcessReplaceOperation(t)}},ProcessReplaceOperation:function(t){this.ProcessDeleteOperation(t,"diffmod"),this.ProcessInsertOperation(t,"diffmod")},ProcessInsertOperation:function(t,s){var n=this.array_slice(this.newWords,t.StartInNew,t.EndInNew);this.InsertTag("ins",s,n)},ProcessDeleteOperation:function(t,s){var n=this.array_slice(this.oldWords,t.StartInOld,t.EndInOld);this.InsertTag("del",s,n)},ProcessEqualOperation:function(t){var s=this.array_slice(this.newWords,t.StartInNew,t.EndInNew);this.content.push(s.join(""))},preg_match_array:function(t,s){for(var n=0,i=0;i<t.length;i++)n|=new RegExp(t[i]).test(s);return n},InsertTag:function(t,s,n){for(;;){if(0==n.length)break;var i=this.ExtractConsecutiveWords(n,!1),r=i.items;n=i.words;var e="",a=!1;if(0!=r.length){var h=this.WrapText(r.join(""),t,s);this.content.push(h)}else this.preg_match_array(this.specialCaseOpeningTags,n[0])?(e='<ins class="mod">',"del"==t&&n.shift()):this.in_array(n[0],this.specialCaseClosingTags)&&(e="</ins>",a=!0,"del"==t&&n.shift());if(0==n.length&&0==e.length)break;if(a){var o=this.ExtractConsecutiveWords(n,!0);n=o.words,this.content.push(e+o.items.join(""))}else{var o=this.ExtractConsecutiveWords(n,!0);n=o.words,this.content.push(o.items.join("")+e)}}},in_array:function(t,s){for(var n=0;n<s.length;n++)if(s[n]==t)return!0;return!1},WrapText:function(t,s,n){return"<"+s+' class="'+n+'">'+t+"</"+s+">"},ExtractConsecutiveWords:function(t,s){for(var n=!1,i=0;i<t.length;i++){var r=t[i];if(s?!this.IsTag(r):!!this.IsTag(r)){n=i;break}}if(n!==!1){var e=this.array_slice(t,0,n);return n>0&&t.splice(0,n),{items:e,words:t}}return e=t,t=new Array,{items:e,words:t}},IsTag:function(t){var s=this.IsOpeningTag(t)||this.IsClosingTag(t);return s},IsOpeningTag:function(t){return/^\s*<[^>]+>\s*$/.test(t)},IsClosingTag:function(t){return/^\s*<\/[^>]+>\s*$/.test(t)},IsStartOfTag:function(t){return"<"==t},IsEndOfTag:function(t){return">"==t},IsWhiteSpace:function(t){return/\s/.test(t)},isNaW:function(t){return/[^\x00-\x80]/.test(t)},array_slice:function(t,s,n,i){return t.slice(s,n)},Match:function(t,s,n){var i={StartInOld:t,StartInNew:s,Size:n};return i.EndInOld=function(){return t+n},i.EndInNew=function(){return s+n},i},Operation:function(t,s,n,i,r){var e={Action:t,StartInOld:s,EndInOld:n,StartInNew:i,EndInNew:r};return e}},t.damoHtmlDiff=new s}(window);